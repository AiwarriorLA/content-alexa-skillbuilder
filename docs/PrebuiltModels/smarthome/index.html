<!DOCTYPE html>

<html>
<head>
  <title>`Smart Home Lab`</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">
'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="smart-home-lab"><code>Smart Home Lab</code></h1>
<p>Setup for account linking and  Messages for Smart Home </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">let</span> AWS = <span class="hljs-built_in">require</span>(<span class="hljs-string">'aws-sdk'</span>);
AWS.config.update({<span class="hljs-attr">region</span>:<span class="hljs-string">'us-east-1'</span>});

<span class="hljs-keyword">let</span> AlexaResponse = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./alexa/skills/smarthome/AlexaResponse"</span>);


exports.handler = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event, context</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Dump the request for logging - check the CloudWatch logs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"index.handler request  -----"</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">JSON</span>.stringify(event));

    <span class="hljs-keyword">if</span> (context !== <span class="hljs-literal">undefined</span>) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"index.handler context  -----"</span>);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">JSON</span>.stringify(context));
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Validate we have an Alexa directive</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!(<span class="hljs-string">'directive'</span> <span class="hljs-keyword">in</span> event)) {
        <span class="hljs-keyword">let</span> aer = <span class="hljs-keyword">new</span> AlexaResponse(
            {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"ErrorResponse"</span>,
                <span class="hljs-string">"payload"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"INVALID_DIRECTIVE"</span>,
                    <span class="hljs-string">"message"</span>: <span class="hljs-string">"Missing key: directive, Is request a valid Alexa directive?"</span>
                }
            });
        <span class="hljs-keyword">return</span> sendResponse(aer.get());
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Check the payload version</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (event.directive.header.payloadVersion !== <span class="hljs-string">"3"</span>) {
        <span class="hljs-keyword">let</span> aer = <span class="hljs-keyword">new</span> AlexaResponse(
            {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"ErrorResponse"</span>,
                <span class="hljs-string">"payload"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"INTERNAL_ERROR"</span>,
                    <span class="hljs-string">"message"</span>: <span class="hljs-string">"This skill only supports Smart Home API version 3"</span>
                }
            });
        <span class="hljs-keyword">return</span> sendResponse(aer.get())
    }

    <span class="hljs-keyword">let</span> namespace = ((event.directive || {}).header || {}).namespace;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h1 id="alexaauthorization"><code>alexa.authorization</code></h1>
<p>Setup Return response for autorization for this lab the authorization will be provided via 
AWS Cognito</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (namespace.toLowerCase() === <span class="hljs-string">'alexa.authorization'</span>) {
        <span class="hljs-keyword">let</span> aar = <span class="hljs-keyword">new</span> AlexaResponse({<span class="hljs-string">"namespace"</span>: <span class="hljs-string">"Alexa.Authorization"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"AcceptGrant.Response"</span>,});
        <span class="hljs-keyword">return</span> sendResponse(aar.get());
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h1 id="alexadiscovery"><code>alexa.discovery</code></h1>
<p>This returns the JSON discovery Message 
This is a list of capabilities for the switch as defined by the PowerController interface. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">if</span> (namespace.toLowerCase() === <span class="hljs-string">'alexa.discovery'</span>) {
        <span class="hljs-keyword">let</span> adr = <span class="hljs-keyword">new</span> AlexaResponse({<span class="hljs-string">"namespace"</span>: <span class="hljs-string">"Alexa.Discovery"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"Discover.Response"</span>});
        <span class="hljs-keyword">let</span> capability_alexa = adr.createPayloadEndpointCapability();
        <span class="hljs-keyword">let</span> capability_alexa_powercontroller = adr.createPayloadEndpointCapability({<span class="hljs-string">"interface"</span>: <span class="hljs-string">"Alexa.PowerController"</span>, <span class="hljs-string">"supported"</span>: [{<span class="hljs-string">"name"</span>: <span class="hljs-string">"powerState"</span>}]});
        adr.addPayloadEndpoint({<span class="hljs-string">"friendlyName"</span>: <span class="hljs-string">"Sample Switch"</span>, <span class="hljs-string">"endpointId"</span>: <span class="hljs-string">"sample-switch-01"</span>, <span class="hljs-string">"capabilities"</span>: [capability_alexa, capability_alexa_powercontroller]});
        <span class="hljs-keyword">return</span> sendResponse(adr.get());
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h1 id="alexapowercontroller"><code>alexa.powercontroller</code></h1>
<p>Setup of the event directives 
Each directive for the specific event has a defined value and response format</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (namespace.toLowerCase() === <span class="hljs-string">'alexa.powercontroller'</span>) {
        <span class="hljs-keyword">let</span> power_state_value = <span class="hljs-string">"OFF"</span>;
        <span class="hljs-keyword">if</span> (event.directive.header.name === <span class="hljs-string">"TurnOn"</span>)
            power_state_value = <span class="hljs-string">"ON"</span>;

        <span class="hljs-keyword">let</span> endpoint_id = event.directive.endpoint.endpointId;
        <span class="hljs-keyword">let</span> token = event.directive.endpoint.scope.token;
        <span class="hljs-keyword">let</span> correlationToken = event.directive.header.correlationToken;

        <span class="hljs-keyword">let</span> ar = <span class="hljs-keyword">new</span> AlexaResponse(
            {
                <span class="hljs-string">"correlationToken"</span>: correlationToken,
                <span class="hljs-string">"token"</span>: token,
                <span class="hljs-string">"endpointId"</span>: endpoint_id
            }
        );
        ar.addContextProperty({<span class="hljs-string">"namespace"</span>:<span class="hljs-string">"Alexa.PowerController"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"powerState"</span>, <span class="hljs-string">"value"</span>: power_state_value});</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Check for an error when setting the state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">let</span> state_set = sendDeviceState(endpoint_id, <span class="hljs-string">"powerState"</span>, power_state_value);
        <span class="hljs-keyword">if</span> (!state_set) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AlexaResponse(
                {
                    <span class="hljs-string">"name"</span>: <span class="hljs-string">"ErrorResponse"</span>,
                    <span class="hljs-string">"payload"</span>: {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"ENDPOINT_UNREACHABLE"</span>,
                        <span class="hljs-string">"message"</span>: <span class="hljs-string">"Unable to reach endpoint database."</span>
                    }
                }).get();
        }

        <span class="hljs-keyword">return</span> sendResponse(ar.get());
    }

};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h1 id="sendresponse"><code>sendResponse</code></h1>
<p>Send the response back from the recieved directive 
This also logs the response in cloud watch</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendResponse</span>(<span class="hljs-params">response</span>)
</span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"index.handler response -----"</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">JSON</span>.stringify(response));
    <span class="hljs-keyword">return</span> response
}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h1 id="senddevicestate"><code>sendDeviceState</code></h1>
<p>Update DyanmoDB the state of the switch </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendDeviceState</span>(<span class="hljs-params">endpoint_id, state, value</span>) </span>{
    <span class="hljs-keyword">let</span> dynamodb = <span class="hljs-keyword">new</span> AWS.DynamoDB({<span class="hljs-attr">apiVersion</span>: <span class="hljs-string">'2012-08-10'</span>});

    <span class="hljs-keyword">let</span> key = state + <span class="hljs-string">"Value"</span>;
    <span class="hljs-keyword">let</span> attribute_obj = {};
    attribute_obj[key] = {<span class="hljs-string">"Action"</span>: <span class="hljs-string">"PUT"</span>, <span class="hljs-string">"Value"</span>: {<span class="hljs-string">"S"</span>: value}};

    <span class="hljs-keyword">let</span> request = dynamodb.updateItem(
        {
            <span class="hljs-attr">TableName</span>: <span class="hljs-string">"SampleSmartHome"</span>,
            <span class="hljs-attr">Key</span>: {<span class="hljs-string">"ItemId"</span>: {<span class="hljs-string">"S"</span>: endpoint_id}},
            <span class="hljs-attr">AttributeUpdates</span>: attribute_obj,
            <span class="hljs-attr">ReturnValues</span>: <span class="hljs-string">"UPDATED_NEW"</span>
        });

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"DynaomDB index.sendDeviceState request -----"</span>);
    <span class="hljs-built_in">console</span>.log(request);

    <span class="hljs-keyword">let</span> response = request.send();

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"DynaomDB index.sendDeviceState response -----"</span>);
    <span class="hljs-built_in">console</span>.log(response);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
